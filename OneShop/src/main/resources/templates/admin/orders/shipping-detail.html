<!DOCTYPE html>
<html lang="vi" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/admin}">

<head>
    <title>Chi tiết đơn vận chuyển | OneShop</title>
    <link rel="stylesheet" th:href="@{/assets/css/order.css}">
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/leaflet/leaflet.css}">
</head>

<body class="shipping-detail-page">
<h4 class="fw-bold py-3 mb-4" layout:fragment="page_title">
    <a th:href="@{/admin/shipping}" class="text-muted me-2">
        <i class="bx bx-arrow-back"></i>
    </a>
    <span>Chi tiết đơn vận chuyển</span>
</h4>

<main layout:fragment="content">
    <div class="container-xxl flex-grow-1 container-p-y">
        <div class="row">
            <!-- Thông tin đơn vận chuyển -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Thông tin đơn vận chuyển</h5>
                        <div class="dropdown">
                            <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                                <i class="bx bx-dots-vertical-rounded"></i>
                            </button>
                            <div class="dropdown-menu">
                                <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#editShippingModal">
                                    <i class="bx bx-edit me-1"></i> Chỉnh sửa
                                </a>
                                <a th:if="${shipping.active}" href="#" class="dropdown-item text-warning" id="btnDeactivate">
                                    <i class="bx bx-power-off me-1"></i> Ngừng hoạt động
                                </a>
                                <a th:unless="${shipping.active}" href="#" class="dropdown-item text-success" id="btnActivate">
                                    <i class="bx bx-check me-1"></i> Kích hoạt
                                </a>
                                <div class="dropdown-divider"></div>
                                <a href="#" class="dropdown-item text-danger" id="btnDelete">
                                    <i class="bx bx-trash me-1"></i> Xóa
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6>[[${shipping.name}]]</h6>
                            <div class="text-muted">Mã: [[${shipping.code}]]</div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Phí vận chuyển:</span>
                                <strong>[[${#numbers.formatDecimal(shipping.fee, 0, 'COMMA', 0, 'POINT')}]]₫</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span>Thời gian giao hàng:</span>
                                <strong>[[${shipping.deliveryTime}]] ngày</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Trạng thái:</span>
                                <span th:classappend="${'badge ' + (shipping.active ? 'bg-label-success' : 'bg-label-secondary')}">
                                    [[${shipping.active ? 'Đang hoạt động' : 'Ngừng hoạt động'}]]
                                </span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <p class="mb-0">[[${shipping.description ?: 'Không có mô tả'}]]</p>
                        </div>
                    </div>
                </div>

                <!-- Thống kê đơn hàng -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Thống kê đơn hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <div class="text-center">
                                <div class="badge bg-label-primary rounded-pill p-2 mb-2">
                                    <i class='bx bx-package fs-4'></i>
                                </div>
                                <h4 class="mb-0">[[${stats.totalOrders}]]</h4>
                                <small class="text-muted">Tổng đơn hàng</small>
                            </div>
                            <div class="text-center">
                                <div class="badge bg-label-warning rounded-pill p-2 mb-2">
                                    <i class='bx bx-time fs-4'></i>
                                </div>
                                <h4 class="mb-0">[[${stats.pendingOrders}]]</h4>
                                <small class="text-muted">Đang chờ</small>
                            </div>
                            <div class="text-center">
                                <div class="badge bg-label-success rounded-pill p-2 mb-2">
                                    <i class='bx bx-check-circle fs-4'></i>
                                </div>
                                <h4 class="mb-0">[[${stats.deliveredOrders}]]</h4>
                                <small class="text-muted">Đã giao</small>
                            </div>
                        </div>
                        <div class="progress mb-3" style="height: 10px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 th:style="'width: ' + ${stats.deliveryRate} + '%'" 
                                 th:aria-valuenow="${stats.deliveryRate}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100"></div>
                        </div>
                        <div class="text-center small">
                            Tỷ lệ giao hàng thành công: <strong>[[${#numbers.formatDecimal(stats.deliveryRate, 1, 1)}]]%</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danh sách đơn hàng -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Đơn hàng sử dụng [[${shipping.name}]]</h5>
                        <div class="d-flex">
                            <div class="input-group input-group-merge me-2" style="width: 200px;">
                                <span class="input-group-text"><i class='bx bx-filter-alt'></i></span>
                                <select class="form-select" id="filterOrderStatus">
                                    <option value="">Tất cả trạng thái</option>
                                    <option value="PENDING">Chờ xử lý</option>
                                    <option value="PROCESSING">Đang xử lý</option>
                                    <option value="SHIPPING">Đang giao hàng</option>
                                    <option value="DELIVERED">Đã giao hàng</option>
                                    <option value="CANCELLED">Đã hủy</option>
                                </select>
                            </div>
                            <div class="input-group input-group-merge" style="width: 200px;">
                                <span class="input-group-text"><i class='bx bx-calendar'></i></span>
                                <input type="text" class="form-control" id="orderDateRange" placeholder="Chọn ngày">
                            </div>
                        </div>
                    </div>
                    <div class="card-datatable table-responsive">
                        <table class="datatables-orders table">
                            <thead>
                                <tr>
                                    <th>Mã đơn hàng</th>
                                    <th>Khách hàng</th>
                                    <th>Ngày đặt</th>
                                    <th>Tổng tiền</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="order : ${orders}">
                                    <td>
                                        <a th:href="@{/admin/orders/{id}(id=${order.id})}" class="fw-medium">
                                            [[${'#' + order.code}]]
                                        </a>
                                    </td>
                                    <td>[[${order.customerName}]]</td>
                                    <td>[[${#temporals.format(order.orderDate, 'dd/MM/yyyy')}]]</td>
                                    <td>[[${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')}]]₫</td>
                                    <td>
                                        <span th:classappend="${'badge ' + order.status.badgeClass}">
                                            [[${order.status.displayName}]]
                                        </span>
                                    </td>
                                    <td>
                                        <a th:href="@{/admin/orders/{id}(id=${order.id})}" class="btn btn-sm btn-icon">
                                            <i class="bx bx-show"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chỉnh sửa đơn vị vận chuyển -->
    <div class="modal fade" id="editShippingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa đơn vị vận chuyển</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editShippingForm" th:action="@{/admin/shipping/}" + ${shipping.id} method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Tên đơn vị <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" th:value="${shipping.name}" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Mã đơn vị <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="code" th:value="${shipping.code}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Phí vận chuyển <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="fee" 
                                               th:value="${shipping.fee}" required min="0">
                                        <span class="input-group-text">₫</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Thời gian giao hàng <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="deliveryTime" 
                                       th:value="${shipping.deliveryTime}" required min="1">
                                <span class="input-group-text">ngày</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control" name="description" rows="3" 
                                      th:text="${shipping.description}"></textarea>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" name="active" id="editActiveSwitch" 
                                   th:checked="${shipping.active}">
                            <label class="form-check-label" for="editActiveSwitch">Kích hoạt</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>

<!-- Vendor JS -->
<script th:src="@{/assets/vendor/libs/jquery/jquery.js}"></script>
<script th:src="@{/assets/vendor/libs/datatables-bs5/datatables-bootstrap5.js}"></script>
<script th:src="@{/assets/vendor/libs/leaflet/leaflet.js}"></script>
<script th:src="@{/assets/vendor/libs/moment/moment.js}"></script>
<script th:src="@{/assets/vendor/libs/daterangepicker/daterangepicker.js}"></script>
<script th:src="@{/assets/js/order.js}"></script>
</body>
</html>
