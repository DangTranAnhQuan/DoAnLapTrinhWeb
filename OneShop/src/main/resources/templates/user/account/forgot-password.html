<!doctype html>
<html class="no-js" lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>OneShop || Quên Mật Khẩu</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/web/assets/images/favicon.png}">
    <link rel="stylesheet" th:href="@{/web/assets/css/vendor/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/web/assets/css/vendor/font-awesome.css}">
    <link rel="stylesheet" th:href="@{/web/assets/css/style.min.css}">
    <style>
        /* Giữ panel OTP gọn gàng và không bị text dọc */
        #otp-panel .btn,
        #otp-panel button { white-space: nowrap }
        #otp-panel.disabled { opacity: .6; pointer-events: none; }
    </style>
</head>
<body>
<div class="axil-signin-area">

    <!-- Header -->
    <div class="signin-header">
        <div class="row align-items-center">
            <div class="col-xl-4 col-sm-6">
                <a th:href="@{/}" class="site-logo">
                    <img th:src="@{/web/assets/images/logo/logo.png}" alt="logo">
                </a>
            </div>
            <div class="col-md-2 d-lg-block d-none">
                <a th:href="@{/sign-in}" class="back-btn"><i class="far fa-angle-left"></i></a>
            </div>
            <div class="col-xl-6 col-lg-4 col-sm-6">
                <div class="singin-header-btn">
                    <p>Đã là thành viên?</p>
                    <a th:href="@{/sign-in}" class="sign-up-btn axil-btn btn-bg-secondary">Đăng Nhập</a>
                </div>
            </div>
        </div>
    </div>
    <!-- /Header -->

    <div class="row">
        <div class="col-xl-4 col-lg-6">
            <div class="axil-signin-banner bg_image bg_image--10">
                <h3 class="title">Chúng tôi cung cấp sản phẩm tốt nhất</h3>
            </div>
        </div>

        <div class="col-lg-6 offset-xl-2">
            <div class="axil-signin-form-wrap">
                <div class="axil-signin-form">

                    <h3 class="title mb-2">Quên mật khẩu?</h3>
                    <p class="b2 mb--30">Nhập email để nhận mã OTP (hiệu lực 60 giây) và đặt lại mật khẩu.</p>

                    <!-- Flash từ server nếu có -->
                    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
                    <div th:if="${info}" class="alert alert-info" th:text="${info}"></div>
                    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

                    <!-- Alert động phía client -->
                    <div id="alertBox" class="alert d-none" role="alert"></div>

                    <!-- B1: Nhập email để nhận OTP -->
                    <form class="singin-form mb-4" id="formSendOtp" autocomplete="off">
                        <div class="form-group">
                            <label>Email</label>
                            <input id="fpEmail" type="email" class="form-control" name="email" placeholder="you@example.com" required>
                        </div>
                        <div class="form-group">
                            <button id="btnSendOtp" type="submit" class="axil-btn btn-bg-primary submit-btn">
                                Nhận mã xác thực OTP
                            </button>
                        </div>
                    </form>

                    <!-- B2: Nhập OTP -->
                    <div id="otp-panel" class="card p-3 disabled">
                        <h6 class="mb-3">Nhập mã OTP đã gửi qua email</h6>
                        <form id="formVerifyOtp" class="row g-2 align-items-end" autocomplete="off">
                            <div class="col-md-6">
                                <label class="form-label">Mã OTP</label>
                                <input id="fpOtp" type="text" class="form-control" name="otp" maxlength="6" pattern="[0-9]{6}" placeholder="6 chữ số" required>
                            </div>
                            <div class="col-md-3">
                                <button id="btnVerifyOtp" type="submit" class="axil-btn w-100">Xác minh</button>
                            </div>
                        </form>

                        <div class="mt-2 d-flex align-items-center gap-2">
                            <button id="btnResendOtp" class="axil-btn btn-outline" disabled>Gửi lại (60s)</button>
                            <small id="timerText" class="text-muted">Mã OTP chỉ có hiệu lực trong 60 giây kể từ khi gửi.</small>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script th:src="@{/web/assets/js/vendor/jquery.js}"></script>
<script th:src="@{/web/assets/js/vendor/bootstrap.min.js}"></script>
<script th:src="@{/web/assets/js/main.js}"></script>
<script>
    (function () {
      const alertBox = document.getElementById('alertBox');

      const emailInput  = document.getElementById('fpEmail');
      const formSendOtp = document.getElementById('formSendOtp');
      const btnSendOtp  = document.getElementById('btnSendOtp');

      const otpPanel    = document.getElementById('otp-panel');
      const otpInput    = document.getElementById('fpOtp');
      const formVerify  = document.getElementById('formVerifyOtp');
      const btnVerify   = document.getElementById('btnVerifyOtp');
      const btnResend   = document.getElementById('btnResendOtp');
      const timerText   = document.getElementById('timerText');

      let countdownTimer = null;
      let left = 0;

      setOtpEnabled(false);

      formSendOtp.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = (emailInput.value || '').trim();
        if (!email) return showAlert('Vui lòng nhập email', 'danger');

        btnSendOtp.disabled = true;

        try {
          const resp = await fetch('/forgot-password/send-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({email})
          });
          const data = await resp.json();
          if (!resp.ok || !data.ok) {
            showAlert(data.message || 'Gửi OTP thất bại', 'danger');
            btnSendOtp.disabled = false;
            return;
          }
          // Thành công: bật panel OTP + bắt đầu đếm ngược
          showAlert('Đã gửi OTP tới email của bạn', 'success');
          setOtpEnabled(true);
          startCountdown(data.expiresIn ?? 60);
        } catch (err) {
          showAlert('Không thể gửi OTP. Vui lòng thử lại.', 'danger');
        } finally {
          btnSendOtp.disabled = false;
        }
      });

      formVerify.addEventListener('submit', async (e) => {
        e.preventDefault();
        const otp = (otpInput.value || '').trim();
        if (otp.length !== 6) return showAlert('OTP gồm 6 chữ số', 'warning');

        btnVerify.disabled = true;
        try {
          const resp = await fetch('/forgot-password/verify-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({otp})
          });
          const data = await resp.json();
          if (!resp.ok || !data.ok) {
            showAlert(data.message || 'OTP không hợp lệ', 'danger');
            return;
          }
          // OK -> sang trang đặt mật khẩu mới
          window.location.href = '/reset-password';
        } catch (err) {
          showAlert('Không thể xác minh OTP. Vui lòng thử lại.', 'danger');
        } finally {
          btnVerify.disabled = false;
        }
      });

      btnResend.addEventListener('click', async (e) => {
        e.preventDefault();
        if (left > 0) return; // đang đếm ngược thì không cho bấm

        btnResend.disabled = true;
        try {
          const resp = await fetch('/forgot-password/resend-otp', { method: 'POST' });
          const data = await resp.json();
          if (!resp.ok || !data.ok) {
            showAlert(data.message || 'Gửi lại OTP thất bại', 'danger');
            btnResend.disabled = false;
            return;
          }
          showAlert('Đã gửi lại OTP', 'success');
          startCountdown(data.expiresIn ?? 60);
        } catch (err) {
          showAlert('Không thể gửi lại OTP. Vui lòng thử lại.', 'danger');
          btnResend.disabled = false;
        }
      });

      function setOtpEnabled(enabled) {
        otpPanel.classList.toggle('disabled', !enabled);
        otpInput.disabled  = !enabled;
        btnVerify.disabled = !enabled;
        // nút gửi lại chỉ bật khi hết countdown
        btnResend.disabled = !enabled || left > 0;
      }

      function startCountdown(seconds) {
        if (countdownTimer) clearInterval(countdownTimer);
        left = Math.max(0, seconds|0);
        renderTimer();
        countdownTimer = setInterval(() => {
          left--;
          renderTimer();
          if (left <= 0) {
            clearInterval(countdownTimer);
            countdownTimer = null;
            btnResend.disabled = false;
          }
        }, 1000);
      }

      function renderTimer() {
        if (left > 0) {
          btnResend.textContent = `Gửi lại (${left}s)`;
          btnResend.disabled = true;
          timerText.textContent = `Mã OTP sẽ hết hạn sau ${left}s`;
        } else {
          btnResend.textContent = 'Gửi lại';
          timerText.textContent = 'Mã OTP chỉ có hiệu lực trong 60 giây kể từ khi gửi.';
        }
      }

      function showAlert(message, type) {
        alertBox.className = `alert alert-${type || 'info'}`;
        alertBox.textContent = message;
        alertBox.classList.remove('d-none');
      }
    })();
</script>
</body>
</html>
