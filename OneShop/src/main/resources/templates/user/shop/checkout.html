<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/user}">
<head>
    <title>Thanh toán</title>
    <style>
        .axil-order-summery .summery-table th:nth-child(2),
        .axil-order-summery .summery-table td:nth-child(2) {
            text-align: right; white-space: nowrap; font-variant-numeric: tabular-nums;
        }
        .axil-order-summery .summery-table .order-shipping td:nth-child(2) {
            display: table-cell !important; text-align: right !important; padding-left: 0 !important;
        }
        .axil-order-summery .summery-table td:nth-child(2) sup,
        .axil-order-summery .summery-table td:nth-child(2) .currency,
        .axil-order-summery .summery-table td:nth-child(2) .woocommerce-Price-currencySymbol {
            position: static !important; top: 0 !important; vertical-align: baseline !important; font-size: 1em !important; line-height: 1 !important;
        }
        .axil-order-summery { width: 100%; }
        .custom-address-option input[type="radio"]:checked + label {
            border-color: var(--color-primary); box-shadow: 0 0 0 0px var(--color-primary);
        }
        #shipping-options-loading, #shipping-methods-loading { display: none; }
        #shipping-info-display { margin-top: 5px; font-size: 0.9em; color: #555; }
        #shipping-error, #shipping-methods-error { margin-top: 10px; }

        #shipping-method-selection { border-top: 1px solid #e5e5e5; padding-top: 20px; margin-top: 30px; }
        .shipping-method-option { margin-bottom: 15px; }
        .shipping-method-option input[type="radio"] { margin-right: 10px; }
        .shipping-method-option label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            font-weight: normal;
            cursor: pointer;
        }
        .shipping-method-option label .method-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
         .shipping-method-option label .method-name {
             font-weight: 500;
             color: #333;
         }
         .shipping-method-option label .method-time {
             font-size: 0.9em;
             color: #666;
         }
        .shipping-method-option label .method-fee {
            font-weight: 600;
            white-space: nowrap;
            margin-left: 15px;
        }
        .shipping-method-option input[type="radio"]:checked + label {
             color: var(--color-primary);
        }
    </style>
</head>

<body>
<main layout:fragment="content">
    <div class="axil-checkout-area axil-section-gap">
        <div class="container">
            <form id="checkout-form" th:action="@{/place-order}" method="post">
                <input type="hidden" name="calculated_shipping_fee" id="calculated_shipping_fee" value="0">
                <input type="hidden" name="shipping_method_name" id="shipping_method_name" value="">
                <input type="hidden" name="shipping_option_id" id="shipping_option_id" value="">

                <div class="row">
                    <div class="col-lg-6">
                        <div class="axil-checkout-billing">
                            <h4 class="title mb--40">Chi tiết giao hàng</h4>
                            <div class="mb-4">
                                <a th:href="@{/cart}" class="axil-btn btn-outline btn-sm"><i class="fal fa-long-arrow-left"></i> Quay lại giỏ hàng</a>
                            </div>
                            <div th:if="${error}" th:text="${error}" class="alert alert-danger"></div>

                            <div th:if="${addresses == null or addresses.isEmpty()}" class="mb-4">
                            </div>
                            <div th:if="${addresses != null and !addresses.isEmpty()}">
                                <div th:each="address, iter : ${addresses}" class="custom-address-option">
                                    <div class="address-main-content">
                                        <input type="radio" name="shipping_address"
                                               th:id="'address' + ${iter.index}"
                                               th:value="${address.maDiaChi}"
                                               th:checked="${iter.index == 0}"
                                               class="address-radio">
                                        <label th:for="'address' + ${iter.index}" class="address-content" th:data-province="${address.tinhThanh}">
                                            <div class="address-header">
                                                <strong th:text="${address.tenNguoiNhan} + ' | ' + ${address.soDienThoai}"></strong>
                                            </div>
                                            <span class="address-details"
                                                  th:text="${address.soNhaDuong} + ', ' + ${address.phuongXa} + ', ' + ${address.quanHuyen} + ', ' + ${address.tinhThanh}"></span>
                                        </label>
                                    </div>
                                    <a th:href="@{/checkout/edit-address/{id}(id=${address.maDiaChi})}" class="btn-sm address-edit-btn">Sửa</a>
                                </div>
                            </div>

                            <div id="shipping-method-selection" class="mt-4">
                                <h5 class="title mb--20">Phương thức vận chuyển</h5>
                                <div id="shipping-methods-loading" class="text-center">
                                    <div class="spinner-border spinner-border-sm ms-2" role="status"><span class="visually-hidden">Loading...</span></div>
                                    <span>Đang tìm phương thức vận chuyển...</span>
                                </div>
                                <div id="shipping-methods-error" class="alert alert-warning" style="display: none;"></div>
                                <div id="shipping-options-list">
                                    <p class="text-muted" id="shipping-placeholder">Vui lòng chọn địa chỉ giao hàng để xem các tùy chọn vận chuyển.</p>
                                </div>
                            </div>

                            <div class="form-group mt-4">
                                <label>Ghi chú đơn hàng (tùy chọn)</label>
                                <textarea name="notes" rows="2" placeholder="Ghi chú về đơn hàng của bạn..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="axil-order-summery order-checkout-summery">
                            <h5 class="title mb--20">Đơn hàng của bạn</h5>
                            <div class="summery-table-wrap">
                                <table class="table summery-table">
                                    <colgroup><col><col style="width: 170px;"></colgroup>
                                    <thead><tr><th>Sản phẩm</th><th>Tạm tính</th></tr></thead>
                                    <tbody>
                                    <tr th:each="item : ${cartItems}" class="order-product">
                                        <td th:text="${item.sanPham.tenSanPham} + ' x ' + ${item.soLuong}"></td>
                                        <td th:text="${#numbers.formatDecimal(item.thanhTien, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                                    </tr>
                                    <tr class="order-subtotal">
                                        <td>Tạm tính</td>
                                        <td th:text="${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                                    </tr>
                                    <tr class="order-shipping text-success" th:if="${membershipDiscount != null and membershipDiscount > 0}">
                                        <td>Giảm giá hạng <strong th:text="${membershipTier != null ? membershipTier.tenHang : ''}"></strong></td>
                                        <td th:text="'-' + ${#numbers.formatDecimal(membershipDiscount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                                    </tr>
                                    <tr class="order-shipping text-success" th:if="${couponDiscount != null and couponDiscount > 0}">
                                        <td>Mã giảm giá</td>
                                        <td th:text="'-' + ${#numbers.formatDecimal(couponDiscount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                                    </tr>
                                    <tr class="order-shipping">
                                        <td>Phí vận chuyển</td>
                                        <td id="shipping-fee-amount" th:text="${#numbers.formatDecimal(shippingFee, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                                    </tr>
                                    <tr class="order-total">
                                        <td>Tổng cộng</td>
                                        <td id="total-amount" class="order-total-amount"
                                            th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div id="shipping-error" class="alert alert-warning mt-3" style="display: none;"></div>

                            <div class="order-payment-method">
                                <div class="single-payment">
                                    <div class="input-group">
                                        <input type="radio" id="pmCOD" name="payment_method" value="COD" checked>
                                        <label for="pmCOD">Thanh toán khi nhận hàng (COD)</label>
                                    </div>
                                    <p>Thanh toán bằng tiền mặt khi nhận hàng.</p>
                                </div>
                                <div class="single-payment">
                                    <div class="input-group">
                                        <input type="radio" id="pmVietQR" name="payment_method" value="ONLINE">
                                        <label for="pmVietQR">Chuyển khoản VietQR</label>
                                    </div>
                                    <p>Tự động tạo mã QR cho đơn hàng của bạn.</p>
                                </div>
                            </div>

                            <button type="submit"
                                    id="place-order-button"
                                    class="axil-btn btn-bg-primary checkout-btn"
                                    th:disabled="${addresses == null or addresses.isEmpty()}">
                                Tiếp tục thanh toán
                            </button>
                            <div th:if="${addresses == null or addresses.isEmpty()}" class="text-danger mt-2 small">
                                Vui lòng thêm địa chỉ giao hàng.
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</main>

<th:block layout:fragment="script">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Lấy các element cần thiết
            const addressRadios = document.querySelectorAll('input[name="shipping_address"]');
            const shippingFeeElement = document.getElementById('shipping-fee-amount');
            const totalAmountElement = document.getElementById('total-amount');
            const shippingMethodsLoading = document.getElementById('shipping-methods-loading');
            const shippingMethodsErrorDiv = document.getElementById('shipping-methods-error');
            const shippingOptionsListDiv = document.getElementById('shipping-options-list');
            const shippingPlaceholder = document.getElementById('shipping-placeholder');
            const checkoutButton = document.getElementById('place-order-button');
            const calculatedShippingFeeInput = document.getElementById('calculated_shipping_fee');
            const shippingMethodNameInput = document.getElementById('shipping_method_name');
            const shippingOptionIdInput = document.getElementById('shipping_option_id');

            // Lấy giá trị tiền từ Thymeleaf
            const subtotal = parseFloat('[[${subtotal}]]') || 0;
            const couponDiscount = parseFloat('[[${couponDiscount ?: 0}]]') || 0;
            const membershipDiscount = parseFloat('[[${membershipDiscount ?: 0}]]') || 0;
            let currentShippingFee = 0;

            function formatCurrency(amount) {
                if (amount == null || isNaN(amount)) return '0 ₫';
                return Math.round(amount).toLocaleString('vi-VN') + ' ₫';
            }

            function updateTotalAmount() {
                const total = subtotal - couponDiscount - membershipDiscount + currentShippingFee;
                totalAmountElement.textContent = formatCurrency(Math.max(0, total));
            }

            async function fetchShippingOptions(province) {
                shippingMethodsLoading.style.display = 'block';
                shippingMethodsErrorDiv.style.display = 'none';
                shippingOptionsListDiv.innerHTML = '';
                shippingPlaceholder.style.display = 'none';
                checkoutButton.disabled = true;
                currentShippingFee = 0;
                updateTotalAmount();
                shippingFeeElement.textContent = formatCurrency(0);
                calculatedShippingFeeInput.value = '0';
                shippingMethodNameInput.value = '';
                shippingOptionIdInput.value = '';

                try {
                    const response = await fetch(`/api/available-shipping-options?province=${encodeURIComponent(province)}`);

                    if (!response.ok) {
                        let errorMsg = `Lỗi HTTP: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.error || errorMsg;
                        } catch (e) {}
                        throw new Error(errorMsg);
                    }

                    const shippingOptions = await response.json();

                    if (!shippingOptions || shippingOptions.length === 0) {
                        throw new Error('Không tìm thấy phương thức vận chuyển phù hợp cho địa chỉ này.');
                    }

                    shippingOptions.forEach((option, index) => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'shipping-method-option form-group';

                        const radioInput = document.createElement('input');
                        radioInput.type = 'radio';
                        radioInput.name = 'shipping_option';

                        // === SỬA LỖI: ĐỌC ĐÚNG TÊN TRƯỜNG TỪ DTO ===
                        radioInput.id = `shipping_opt_${option.maChiPhiVC}`; // Dùng maChiPhiVC
                        radioInput.value = option.maChiPhiVC; // Dùng maChiPhiVC
                        radioInput.dataset.fee = option.chiPhi; // Dùng chiPhi
                        radioInput.dataset.name = option.tenGoiCuoc; // Dùng tenGoiCuoc (đã chứa tên kết hợp)
                        // === KẾT THÚC SỬA ===

                        const label = document.createElement('label');
                        label.htmlFor = `shipping_opt_${option.maChiPhiVC}`;

                        const detailsSpan = document.createElement('span');
                        detailsSpan.className = 'method-details';

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'method-name';
                        // === SỬA LỖI: ĐỌC ĐÚNG TÊN TRƯỜNG TỪ DTO ===
                        nameSpan.textContent = option.tenGoiCuoc || 'Gói vận chuyển'; // Dùng tenGoiCuoc
                        detailsSpan.appendChild(nameSpan);

                        // === SỬA LỖI: XÂY DỰNG CHUỖI THỜI GIAN TỪ CÁC TRƯỜNG CỦA DTO ===
                        if (option.ngayGiaoSomNhat && option.ngayGiaoMuonNhat && option.donViThoiGian) {
                            const timeSpan = document.createElement('span');
                            timeSpan.className = 'method-time';
                            timeSpan.textContent = `(Dự kiến ${option.ngayGiaoSomNhat}-${option.ngayGiaoMuonNhat} ${option.donViThoiGian})`;
                            detailsSpan.appendChild(timeSpan);
                        }
                        // === KẾT THÚC SỬA ===

                        const feeSpan = document.createElement('span');
                        feeSpan.className = 'method-fee';
                        // === SỬA LỖI: ĐỌC ĐÚNG TÊN TRƯỜNG TỪ DTO ===
                        feeSpan.textContent = formatCurrency(option.chiPhi); // Dùng chiPhi
                        // === KẾT THÚC SỬA ===

                        label.appendChild(detailsSpan);
                        label.appendChild(feeSpan);

                        optionDiv.appendChild(radioInput);
                        optionDiv.appendChild(label);
                        shippingOptionsListDiv.appendChild(optionDiv);

                        radioInput.addEventListener('change', function() {
                            if (this.checked) {
                                currentShippingFee = parseFloat(this.dataset.fee) || 0;
                                calculatedShippingFeeInput.value = currentShippingFee.toFixed(0);
                                shippingMethodNameInput.value = this.dataset.name || '';
                                shippingOptionIdInput.value = this.value || '';
                                shippingFeeElement.textContent = formatCurrency(currentShippingFee);
                                updateTotalAmount();
                                checkoutButton.disabled = false;
                            }
                        });
                    });

                    const firstOptionRadio = shippingOptionsListDiv.querySelector('input[name="shipping_option"]');
                    if(firstOptionRadio){
                        firstOptionRadio.checked = true;
                        firstOptionRadio.dispatchEvent(new Event('change'));
                    } else {
                         checkoutButton.disabled = true;
                    }

                } catch (error) {
                    console.error('Lỗi khi lấy PTVC:', error);
                    shippingMethodsErrorDiv.textContent = error.message || 'Không thể tải phương thức vận chuyển.';
                    shippingMethodsErrorDiv.style.display = 'block';
                    shippingFeeElement.textContent = formatCurrency(0);
                    currentShippingFee = 0;
                    updateTotalAmount();
                    checkoutButton.disabled = true;
                    calculatedShippingFeeInput.value = '0';
                    shippingMethodNameInput.value = '';
                    shippingOptionIdInput.value = '';
                } finally {
                    shippingMethodsLoading.style.display = 'none';
                }
            }

            addressRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        shippingOptionsListDiv.innerHTML = '';
                        shippingPlaceholder.style.display = 'block';
                        shippingMethodsErrorDiv.style.display = 'none';
                        checkoutButton.disabled = true;
                        currentShippingFee = 0;
                        updateTotalAmount();
                        shippingFeeElement.textContent = formatCurrency(0);
                        calculatedShippingFeeInput.value = '0';
                        shippingMethodNameInput.value = '';
                        shippingOptionIdInput.value = '';

                        const selectedLabel = document.querySelector(`label[for="${this.id}"]`);
                        const province = selectedLabel ? selectedLabel.getAttribute('data-province') : null;
                        if (province) {
                            fetchShippingOptions(province);
                        } else {
                            shippingMethodsErrorDiv.textContent = 'Địa chỉ đã chọn thiếu thông tin Tỉnh/Thành phố.';
                            shippingMethodsErrorDiv.style.display = 'block';
                        }
                    }
                });
            });

            const initiallyChecked = document.querySelector('input[name="shipping_address"]:checked');
            if (initiallyChecked) {
                 const initialLabel = document.querySelector(`label[for="${initiallyChecked.id}"]`);
                 const initialProvince = initialLabel ? initialLabel.getAttribute('data-province') : null;
                 if (initialProvince) {
                     checkoutButton.disabled = true;
                     fetchShippingOptions(initialProvince);
                 } else {
                     shippingMethodsErrorDiv.textContent = 'Địa chỉ mặc định thiếu thông tin Tỉnh/Thành phố.';
                     shippingMethodsErrorDiv.style.display = 'block';
                     checkoutButton.disabled = true;
                 }
            } else if (addressRadios.length > 0) {
                 shippingMethodsErrorDiv.textContent = 'Vui lòng chọn một địa chỉ giao hàng.';
                 shippingMethodsErrorDiv.style.display = 'block';
                 checkoutButton.disabled = true;
            } else {
                 checkoutButton.disabled = true;
            }

        });
    </script>
</th:block>

</body>
</html>