<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/user}">

<head>
    <title th:text="${product.tenSanPham}"></title>
    <style>
        .product-sold-info { display: block; font-size: 13px; color: #777; margin-top: 15px; margin-bottom: 10px; min-height: 45px; }
        .product-sold-info .sold-text-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .product-sold-info .sold-label { font-size: 13px; color: #333; font-weight: 500; }
        .product-sold-info .sold-quantity { font-size: 13px; font-weight: 600; color: #333; }
        .sold-progress-bar { width: 100%; height: 8px; background-color: #fce7e7; border-radius: 4px; overflow: hidden; position: relative; }
        .sold-progress { height: 100%; background-color: #f70404; border-radius: 4px; min-width: 5%; }
        .price-amount-wrapper { margin-top: 15px; }
        .product-rating { margin-top: 15px; }
        .product-meta { margin-top: 15px; }
        .description { margin-top: 15px; }
    </style>
    <style>
        .product-promotions-area { background-color: #fdecec; padding: 40px 0; margin-bottom: 40px; }
        .product-promotions-area h2 { text-align: center; font-size: 24px; font-weight: 600; margin-bottom: 30px; color: #333; }
        .promotions-list { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .promotion-card { display: flex; background-color: #fff; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: calc(50% - 10px); max-width: 450px; }
        .promotion-card-icon { background-color: #fba7a7; padding: 20px; display: flex; align-items: center; justify-content: center; width: 100px; flex-shrink: 0; }
        .promotion-card-icon img { max-width: 50px; height: auto; }
        .promotion-card-icon .discount-percent { font-size: 36px; font-weight: bold; color: #fff; line-height: 1; }
        .promotion-card-details { padding: 15px 20px; flex-grow: 1; background-color: #f8f9fa; position: relative; }
        .promotion-card-details .info-icon { position: absolute; top: 10px; right: 10px; font-size: 16px; color: #6c757d; cursor: pointer; border: 1px solid #ccc; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; line-height: 1; }
        .promotion-card-details h6 { font-size: 14px; font-weight: bold; color: #000; margin-bottom: 5px; }
        .promotion-card-details p { font-size: 13px; color: #333; margin-bottom: 8px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: calc(13px * 1.4 * 2); }
        .promotion-card-code-expiry { margin-top: 10px; font-size: 12px; color: #555; }
        .promotion-card-code-expiry .code-line,
        .promotion-card-code-expiry .expiry-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
        .promotion-card-code-expiry .code-label { font-weight: 600; margin-right: 5px; }
        .btn-copy-code { display: block; width: 100%; margin-top: 10px; background-color: #fff; color: var(--color-primary, #e74c3c); border: 1px solid var(--color-primary, #e74c3c); padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; text-align: center; transition: all 0.3s ease; }
        .btn-copy-code:hover { background-color: var(--color-primary, #e74c3c); color: #fff; }
        .btn-copy-code.copied { background-color: #28a745; border-color: #28a745; color: #fff; }

        @media (max-width: 991px) { .promotion-card { width: calc(50% - 10px); } }
        @media (max-width: 767px) {
            .promotion-card { width: 100%; max-width: none; }
            .product-promotions-area h2 { font-size: 20px; }
            .promotion-card-icon { width: 80px; padding: 15px; }
            .promotion-card-icon .discount-percent { font-size: 28px; }
            .promotion-card-details { padding: 15px; padding-bottom: 50px; position:relative; } /* Adjusted padding */
            .promotion-card-details h6 { font-size: 13px; }
            .promotion-card-details p { font-size: 12px; }
            .promotion-card-code-expiry { margin-top: 8px; }
            .promotion-card-code-expiry .code-line,
            .promotion-card-code-expiry .expiry-line { justify-content: flex-start; gap: 5px; }
            .btn-copy-code { position: absolute; bottom: 15px; right: 15px; width: auto; margin-top: 0; float: none; }
        }
    </style>
</head>

<body>
<main layout:fragment="content">
    <div class="axil-single-product-area bg-color-white">
        <div class="single-product-thumb axil-section-gapcommon">
            <div class="container">
                <div class="row">
                    <div class="col-lg-7 mb--40">
                        <div class="row">
                            <div class="col-lg-10 order-lg-2">
                                <div class="single-product-thumbnail-wrap zoom-gallery">
                                    <div class="single-product-thumbnail product-large-thumbnail-3 axil-product">
                                        <div class="thumbnail">
                                            <a th:href="@{'/uploads/' + ${product.hinhAnh}}" class="popup-zoom">
                                                <img th:src="@{'/uploads/' + ${product.hinhAnh}}" th:alt="${product.tenSanPham}">
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 order-lg-1">
                                <div class="product-small-thumb-3 small-thumb-wrapper">
                                    <div class="small-thumb-img">
                                        <img th:src="@{'/uploads/' + ${product.hinhAnh}}" alt="product thumb">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5 mb--40">
                        <div class="single-product-content">
                            <div class="inner">
                                <h2 class="product-title" th:text="${product.tenSanPham}"></h2>
                                <div class="product-sold-info">
                                    <div class="sold-text-line">
                                        <span class="sold-label">Đã bán</span>
                                        <span class="sold-quantity" th:text="${#numbers.formatDecimal(product.totalSold ?: 0, 0, 'COMMA', 0, 'POINT')}"></span>
                                    </div>
                                    <div class="sold-progress-bar">
                                        <div class="sold-progress"
                                             th:if="${product.totalSold != null && product.totalSold > 0}"
                                             th:style="'width: ' + (${product.totalSold % 1000} / 10.0) + '%;'">
                                        </div>
                                    </div>
                                </div>
                                <div class="price-amount-wrapper d-flex align-items-center">
                                    <span class="price current-price" th:text="${#numbers.formatDecimal(product.giaBan, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                                    <span class="price old-price" style="text-decoration: line-through; color: #6c757d; margin-left: 10px;"
                                          th:if="${product.giaNiemYet != null && product.giaNiemYet > product.giaBan}"
                                          th:text="${#numbers.formatDecimal(product.giaNiemYet, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                                </div>
                                <div class="product-rating">
                                    <div class="star-rating" th:if="${totalReviews > 0}">
                                        <span th:text="${#numbers.formatDecimal(averageRating, 1, 1)}"></span>
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <div class="star-rating" th:unless="${totalReviews > 0}">
                                        <span class="text-muted">0.0</span>
                                        <i class="far fa-star text-muted"></i>
                                    </div>
                                    <div class="review-link">
                                        <a href="#reviews" th:text="'(' + ${totalReviews} + ' đánh giá)'"></a>
                                    </div>
                                </div>
                                <div class="product-meta">
                                    <ul class="d-flex">
                                        <li th:if="${product.inventory != null && product.inventory.soLuongTon > 0}"><i class="fal fa-check text-success"></i><span class="text-success">Còn hàng</span></li>
                                        <li th:unless="${product.inventory != null && product.inventory.soLuongTon > 0}"><i class="fal fa-times text-danger"></i><span class="text-danger">Hết hàng</span></li>
                                        <li><i class="fal fa-check"></i>Miễn phí vận chuyển</li>
                                    </ul>
                                </div>
                                <div class="description" th:utext="${product.moTa}"></div>
                                <div id="detail-cart-message" class="mt-2 mb-3"></div>
                                <th:block th:if="${product.inventory != null && product.inventory.soLuongTon > 0}">
                                    <form id="detail-add-cart-form">
                                        <input type="hidden" name="productId" th:value="${product.maSanPham}">
                                        <div class="product-variation quantity-variant-wrapper">
                                            <h6 class="title">Số lượng</h6>
                                            <div class="pro-qty">
                                                <input type="number" name="quantity" class="cart-plus-minus-box" value="1" min="1" th:max="${product.inventory.soLuongTon}">
                                            </div>
                                        </div>
                                        <div class="product-action-wrapper d-flex-center">
                                            <ul class="product-action d-flex-center mb--0">
                                                <li class="add-to-cart">
                                                    <button type="submit" class="axil-btn btn-bg-primary"><i class="far fa-shopping-cart"></i> Thêm vào giỏ</button>
                                                </li>
                                                <li class="wishlist ms-3">
                                                    <a href="javascript:void(0)" class="toggle-wishlist-btn" th:data-product-id="${product.maSanPham}">
                                                        <i class="far fa-heart"></i>
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </form>
                                </th:block>
                                <th:block th:unless="${product.inventory != null && product.inventory.soLuongTon > 0}">
                                    <div class="product-action-wrapper d-flex-center">
                                        <ul class="product-action d-flex-center mb--0">
                                            <li class="add-to-cart">
                                                <button type="button" class="axil-btn btn-bg-primary" disabled style="background-color: #6c757d !important; cursor: not-allowed;"><i class="far fa-shopping-cart"></i> Hết hàng</button>
                                            </li>
                                        </ul>
                                    </div>
                                </th:block>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="product-promotions-area">
        <div class="container">
            <h2>KHUYẾN MÃI DÀNH CHO BẠN</h2>
            <div class="promotions-list" th:if="${promotions != null and not #lists.isEmpty(promotions)}">
                <div th:each="promo : ${promotions}" class="promotion-card">
                    <div class="promotion-card-icon">
                        <img th:if="${promo.kieuApDung == 0}" th:src="@{/web/assets/images/icons/voucher-detail.png}" alt="Voucher Percent">

                        <img th:if="${promo.kieuApDung == 1}" th:src="@{/web/assets/images/icons/hot-deal.png}" alt="Hot Deal">
                    </div>
                    <div class="promotion-card-details">
                        <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="top"
                              th:title="'Điều kiện: Đơn hàng tối thiểu ' + ${#numbers.formatDecimal(promo.tongTienToiThieu ?: 0, 0, 'COMMA', 0, 'POINT')} + '₫' + (${promo.giamToiDa != null} ? '. Giảm tối đa ' + ${#numbers.formatDecimal(promo.giamToiDa, 0, 'COMMA', 0, 'POINT')} + '₫.' : '.')"
                        >ⓘ</span>
                        <h6 th:text="${promo.kieuApDung == 1 ? 'GIẢM ' + #numbers.formatInteger(promo.giaTri/1000, 0) + 'K' : 'GIẢM ' + #numbers.formatInteger(promo.giaTri, 0) + '%'}"></h6>
                        <p th:text="${promo.tenChienDich}">Promotion Description</p>
                        <div class="promotion-card-code-expiry">
                            <div class="code-line">
                                <span class="code-label">Mã:</span> <span th:text="${promo.maKhuyenMai}" class="promo-code-text">CODE</span>
                            </div>
                            <div class="expiry-line" th:if="${promo.ketThucLuc != null}">
                                <span>HSD:</span> <span th:text="${#temporals.format(promo.ketThucLuc, 'dd/MM/yyyy')}"></span>
                            </div>
                        </div>
                        <button class="btn-copy-code">SAO CHÉP MÃ</button>
                    </div>
                </div>
            </div>
            <div th:unless="${promotions != null and not #lists.isEmpty(promotions)}" class="text-center text-muted">
                <p>Hiện chưa có khuyến mãi nào dành cho bạn.</p>
            </div>
        </div>
    </div>
    <div class="woocommerce-tabs wc-tabs-wrapper bg-lighter wc-tab-style-two">
        <div class="container">
            <ul class="nav tabs" role="tablist">
                <li class="nav-item" role="presentation"><a class="active" data-bs-toggle="tab" href="#description">Mô tả sản phẩm</a></li>
                <li class="nav-item" role="presentation"><a data-bs-toggle="tab" href="#reviews">Đánh giá</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="description" role="tabpanel">
                    <div class="product-desc-wrapper" th:utext="${product.moTa}"></div>
                </div>
                <div class="tab-pane fade" id="reviews" role="tabpanel">
                    <div class="reviews-wrapper">
                        <div class="row">
                            <div class="col-lg-6 mb--40">
                                <div class="axil-comment-area pro-desc-commnet-area">
                                    <h5 class="title" th:text="${totalReviews} + ' đánh giá cho sản phẩm này'"></h5>
                                    <ul class="comment-list">
                                        <li th:if="${reviews.isEmpty() and currentUserReview == null}"><p>Chưa có đánh giá nào.</p></li>
                                        <li th:if="${currentUserReview != null}" class="comment your-review-item">
                                            <div class="comment-body">
                                                <div class="single-comment">
                                                    <div class="comment-inner">
                                                        <h6 class="commenter" th:text="${currentUserReview.nguoiDung?.hoTen} + ' (Bạn)'"></h6>
                                                        <div class="comment-rating rating-stars mb-2" style="direction: ltr; font-size: 16px;" th:with="score=${currentUserReview.diemDanhGia}">
                                                            <span th:each="i : ${#numbers.sequence(1, 5)}" th:classappend="${i <= score ? 'text-warning' : 'text-secondary'}">★</span>
                                                        </div>
                                                        <div class="comment-text"><p th:text="${currentUserReview.binhLuan}"></p></div>
                                                        <div class="review-media mt-3 d-flex gap-3">
                                                            <a th:if="${currentUserReview.imageUrl}" th:href="@{'/uploads/' + ${currentUserReview.imageUrl}}" data-mfp-src="" class="popup-image"><img th:src="@{'/uploads/' + ${currentUserReview.imageUrl}}" alt="Review Image" style="max-width: 80px; height: auto;"></a>
                                                            <video th:if="${currentUserReview.videoUrl}" controls style="max-width: 150px; height: auto;"><source th:src="@{'/uploads/' + ${currentUserReview.videoUrl}}"></video>
                                                        </div>
                                                        <small class="text-muted" th:text="${#temporals.format(currentUserReview.ngayTao, 'dd/MM/yyyy HH:mm')}"></small>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                        <li th:each="review : ${reviews}" class="comment">
                                            <div class="comment-body">
                                                <div class="single-comment">
                                                    <div class="comment-inner">
                                                        <h6 class="commenter" th:text="${review.nguoiDung?.hoTen}"></h6>
                                                        <div class="comment-rating rating-stars mb-2" style="direction: ltr; font-size: 16px;" th:with="score=${review.diemDanhGia}">
                                                            <span th:each="i : ${#numbers.sequence(1, 5)}" th:classappend="${i <= score ? 'text-warning' : 'text-secondary'}">★</span>
                                                        </div>
                                                        <div class="comment-text"><p th:text="${review.binhLuan}"></p></div>
                                                        <div class="review-media mt-3 d-flex gap-3">
                                                            <a th:if="${review.imageUrl}" th:href="@{'/uploads/' + ${review.imageUrl}}" data-mfp-src="" class="popup-image"><img th:src="@{'/uploads/' + ${review.imageUrl}}" alt="Review Image" style="max-width: 80px; height: auto;"></a>
                                                            <video th:if="${review.videoUrl}" controls style="max-width: 150px; height: auto;"><source th:src="@{'/uploads/' + ${review.videoUrl}}"></video>
                                                        </div>
                                                        <small class="text-muted" th:text="${#temporals.format(review.ngayTao, 'dd/MM/yyyy HH:mm')}"></small>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-lg-6 mb--40">
                                <div class="comment-respond pro-des-commend-respond mt--0">
                                    <div sec:authorize="!isAuthenticated()">
                                        <h5 class="title mb--30">Thêm đánh giá</h5>
                                        <div class="alert alert-warning">Vui lòng <a th:href="@{/sign-in}">đăng nhập</a> để để lại đánh giá.</div>
                                    </div>
                                    <div sec:authorize="isAuthenticated()">
                                        <div th:if="${currentUserReview != null}">
                                            <h5 class="title mb--30">Đánh giá của bạn</h5>
                                            <div class="your-review-box p-3 border rounded">
                                                <div class="rating-stars mb-2" style="direction: ltr; font-size: 20px;" th:with="score=${currentUserReview.diemDanhGia}">
                                                    <span th:each="i : ${#numbers.sequence(1, 5)}" th:classappend="${i <= score ? 'text-warning' : 'text-secondary'}">★</span>
                                                </div>
                                                <p id="your-review-comment" class="mb-2" th:text="${currentUserReview.binhLuan}"></p>
                                                <div class="review-media mt-3 d-flex gap-3">
                                                    <a th:if="${currentUserReview.imageUrl}" th:href="@{'/uploads/' + ${currentUserReview.imageUrl}}" data-mfp-src="" class="popup-image"><img th:src="@{'/uploads/' + ${currentUserReview.imageUrl}}" alt="Review Image" style="max-width: 80px; height: auto;"></a>
                                                    <video th:if="${currentUserReview.videoUrl}" controls style="max-width: 150px; height: auto;"><source th:src="@{'/uploads/' + ${currentUserReview.videoUrl}}"></video>
                                                </div>
                                                <span id="your-review-data" th:data-score="${currentUserReview.diemDanhGia}" style="display: none;"></span>
                                                <button type="button" class="axil-btn btn-bg-secondary w-100 mt-3" id="open-edit-review-modal-btn">Sửa đánh giá</button>
                                            </div>
                                        </div>
                                        <div th:if="${canReview}">
                                            <h5 class="title mb--30">Thêm đánh giá</h5>
                                            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
                                            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
                                            <form th:action="@{/submit-review}" method="post" enctype="multipart/form-data" class="rating-form">
                                                <input type="hidden" name="productId" th:value="${product.maSanPham}">
                                                <p class="your-rating mb-2">Đánh giá của bạn <span class="require">*</span></p>
                                                <div class="rating-stars mb-4">
                                                    <input type="radio" id="star5" name="rating" value="5" required/><label for="star5" title="5 sao">★</label>
                                                    <input type="radio" id="star4" name="rating" value="4"/><label for="star4" title="4 sao">★</label>
                                                    <input type="radio" id="star3" name="rating" value="3"/><label for="star3" title="3 sao">★</label>
                                                    <input type="radio" id="star2" name="rating" value="2"/><label for="star2" title="2 sao">★</label>
                                                    <input type="radio" id="star1" name="rating" value="1"/><label for="star1" title="1 sao">★</label>
                                                </div>
                                                <div class="form-group"><label>Bình luận của bạn</label><textarea name="comment" placeholder="Viết bình luận ở đây..." required class="form-control"></textarea></div>
                                                <div class="form-group mb-3 mt-3">
                                                    <div class="upload-card"><h6><i class="fas fa-paperclip"></i> Thêm ảnh hoặc video</h6><input id="mediaFile" name="mediaFile" type="file" accept="image/*,video/*"></div>
                                                    <small id="mediaName" class="text-muted ms-2"></small><div id="mediaError" class="media-error"></div>
                                                    <div class="helper-note" style="font-size: 14px; line-height: 1.5; font-weight: 600; color: #4b5563;">Chỉ đính kèm <b>1 file</b> (ảnh hoặc video), tối đa 20MB.</div>
                                                </div>
                                                <div class="preview-container"><div class="preview-box" id="image-preview-box"><img id="image-preview" alt="Xem trước ảnh"></div><div class="preview-box" id="video-preview-box"><video id="video-preview" controls></video></div></div>
                                                <div class="form-submit"><button type="submit" class="axil-btn btn-bg-primary w-auto">Gửi đánh giá</button></div>
                                            </form>
                                        </div>
                                        <div th:if="${!canReview and currentUserReview == null}">
                                            <h5 class="title mb--30">Thêm đánh giá</h5>
                                            <div class="alert alert-info">Bạn cần mua sản phẩm này để có thể đánh giá.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editReviewModal" tabindex="-1" aria-labelledby="editReviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editReviewModalLabel">Sửa đánh giá của bạn</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-review-form" th:action="@{/update-review}" method="post" enctype="multipart/form-data" class="rating-form">
                        <input type="hidden" name="productId" th:value="${product.maSanPham}">
                        <p class="your-rating mb-2">Đánh giá của bạn <span class="require">*</span></p>
                        <div id="edit-rating-stars" class="rating-stars mb-4">
                            <input type="radio" id="edit-star5" name="rating" value="5" required/><label for="edit-star5" title="5 sao">★</label>
                            <input type="radio" id="edit-star4" name="rating" value="4"/><label for="edit-star4" title="4 sao">★</label>
                            <input type="radio" id="edit-star3" name="rating" value="3"/><label for="edit-star3" title="3 sao">★</label>
                            <input type="radio" id="edit-star2" name="rating" value="2"/><label for="edit-star2" title="2 sao">★</label>
                            <input type="radio" id="edit-star1" name="rating" value="1"/><label for="edit-star1" title="1 sao">★</label>
                        </div>
                        <div class="form-group">
                            <label>Bình luận của bạn</label>
                            <textarea id="edit-comment" name="comment" class="form-control" rows="4" placeholder="Viết bình luận ở đây..." required></textarea>
                        </div>
                        <div class="form-group mb-3 mt-3">
                            <div class="upload-card"><h6><i class="fas fa-paperclip"></i> Thêm/Thay đổi ảnh hoặc video</h6><input id="edit-mediaFile" name="mediaFile" type="file" accept="image/*,video/*"></div>
                            <small id="edit-mediaName" class="text-muted ms-2"></small><div id="edit-mediaError" class="media-error"></div>
                            <div class="helper-note" style="font-size: 14px; line-height: 1.5; font-weight: 600; color: #4b5563;">Tải file mới sẽ thay thế file cũ (nếu có).</div>
                        </div>
                        <div class="preview-container"><div class="preview-box" id="edit-image-preview-box"><img id="edit-image-preview" alt="Xem trước ảnh"></div><div class="preview-box" id="edit-video-preview-box"><video id="edit-video-preview" controls></video></div></div>

                        <div class="form-submit mt-4 d-flex gap-3">
                            <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Hủy</button>
                            <button type="submit" class="axil-btn btn-bg-primary w-100">Lưu thay đổi</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<th:block layout:fragment="script">
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // --- LOGIC CHO UPLOAD FILE (CHO CẢ 2 FORM) ---
            function setupFileUpload(inputId, nameId, errorId, imgBoxId, imgId, videoBoxId, videoId) {
                 const mediaInput = document.getElementById(inputId);
                if (!mediaInput) return;
                const mediaName = document.getElementById(nameId);
                const mediaError = document.getElementById(errorId);
                const imagePreviewBox = document.getElementById(imgBoxId);
                const imagePreview = document.getElementById(imgId);
                const videoPreviewBox = document.getElementById(videoBoxId);
                const videoPreview = document.getElementById(videoId);
                const MAX_SIZE = 20 * 1024 * 1024; // 20MB
                function resetPreview() { if (imagePreviewBox) imagePreviewBox.style.display = 'none'; if (videoPreviewBox) videoPreviewBox.style.display = 'none'; if (imagePreview) imagePreview.src = ''; if (videoPreview) { if (videoPreview.src && videoPreview.src.startsWith('blob:')) { URL.revokeObjectURL(videoPreview.src); } videoPreview.src = ''; } }
                function showError(msg) { if(mediaError) { mediaError.textContent = msg; mediaError.style.display = 'block'; } }
                function clearError() { if(mediaError) { mediaError.textContent = ''; mediaError.style.display = 'none'; } }
                mediaInput.addEventListener('change', function (e) { resetPreview(); clearError(); if(mediaName) mediaName.textContent = ''; const file = e.target.files && e.target.files[0]; if (!file) return; if (file.size > MAX_SIZE) { showError('File vượt quá 20MB.'); mediaInput.value = ''; return; } if(mediaName) mediaName.textContent = file.name; const type = (file.type || '').toLowerCase(); if (type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (evt) => { if(imagePreview) imagePreview.src = evt.target.result; if(imagePreviewBox) imagePreviewBox.style.display = 'block'; }; reader.readAsDataURL(file); } else if (type.startsWith('video/')) { const url = URL.createObjectURL(file); if (videoPreview) { videoPreview.onloadedmetadata = () => { URL.revokeObjectURL(url); }; } if(videoPreview) videoPreview.src = url; if(videoPreviewBox) videoPreviewBox.style.display = 'block'; } else { showError('Định dạng không hỗ trợ. Chỉ nhận ảnh hoặc video.'); mediaInput.value = ''; if(mediaName) mediaName.textContent = ''; } });
                const modalElement = mediaInput.closest('.modal'); if (modalElement) { modalElement.addEventListener('hidden.bs.modal', resetPreview); }
            }
            setupFileUpload('mediaFile', 'mediaName', 'mediaError', 'image-preview-box', 'image-preview', 'video-preview-box', 'video-preview');
            setupFileUpload('edit-mediaFile', 'edit-mediaName', 'edit-mediaError', 'edit-image-preview-box', 'edit-image-preview', 'edit-video-preview-box', 'edit-video-preview');

            // --- LOGIC CHO NÚT SỬA ĐÁNH GIÁ ---
            const openModalButton = document.getElementById('open-edit-review-modal-btn');
            const editModalElement = document.getElementById('editReviewModal');
            if (openModalButton && editModalElement) {
                 const editModal = new bootstrap.Modal(editModalElement);
                 openModalButton.addEventListener('click', function () { const reviewData = document.getElementById('your-review-data'); const score = reviewData.getAttribute('data-score'); const comment = document.getElementById('your-review-comment').innerText; const editForm = document.getElementById('edit-review-form'); if (editForm) { const fileInput = editForm.querySelector('#edit-mediaFile'); if (fileInput) fileInput.value = ''; const imgBox = document.getElementById('edit-image-preview-box'); const img = document.getElementById('edit-image-preview'); const videoBox = document.getElementById('edit-video-preview-box'); const video = document.getElementById('edit-video-preview'); if (imgBox) imgBox.style.display = 'none'; if (videoBox) videoBox.style.display = 'none'; if (img) img.src = ''; if (video) { if (video.src && video.src.startsWith('blob:')) URL.revokeObjectURL(video.src); video.src = ''; } document.getElementById('edit-mediaName').textContent = ''; document.getElementById('edit-mediaError').textContent = ''; document.getElementById('edit-mediaError').style.display = 'none'; } const modalForm = document.getElementById('edit-review-form'); if(modalForm) { modalForm.querySelector('#edit-comment').value = comment; const starRadio = modalForm.querySelector('input[name="rating"][value="' + score + '"]'); if (starRadio) starRadio.checked = true; } editModal.show(); });
            }

            // Ngăn nhập số lượng > max hoặc < 1
            $('.pro-qty input').on('input', function() {
                 var $input = $(this);
                 var currentVal = parseInt($input.val());
                 var max = parseInt($input.attr('max'));
                 var min = parseInt($input.attr('min') || 1);
                 if (isNaN(currentVal) || currentVal < min) { $input.val(min); }
                 else if (max !== undefined && currentVal > max) { $input.val(max); } // Check if max exists
            });


            // --- SCRIPT CHO NÚT SAO CHÉP MÃ ---
             document.querySelectorAll('.btn-copy-code').forEach(button => {
                 button.addEventListener('click', function() {
                     const codeElement = this.closest('.promotion-card-details').querySelector('.promo-code-text');
                     const codeToCopy = codeElement ? codeElement.textContent.trim() : '';
                     if (codeToCopy && navigator.clipboard) {
                         navigator.clipboard.writeText(codeToCopy).then(() => {
                             const originalText = this.textContent;
                             this.textContent = 'Đã sao chép!';
                             this.classList.add('copied');
                             setTimeout(() => {
                                 this.textContent = originalText;
                                 this.classList.remove('copied');
                             }, 1500);
                         }).catch(err => {
                             console.error('Không thể sao chép mã: ', err);
                             alert('Lỗi: Không thể sao chép mã.');
                         });
                     } else if (!navigator.clipboard) {
                         alert('Trình duyệt không hỗ trợ sao chép tự động.');
                     } else {
                         console.error('Không tìm thấy mã để sao chép.');
                     }
                 });
             });

             // Initialize Bootstrap Tooltips (for info icon)
             var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
             var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
               return new bootstrap.Tooltip(tooltipTriggerEl);
             });

        });
    </script>
</th:block>
</body>
</html>